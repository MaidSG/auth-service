<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>控制台 · WebSocket</title>
  <style>
    :root{
      --bg:#f6f6f7;
      --card-bg:rgba(255,255,255,0.7);
      --glass:rgba(255,255,255,0.6);
      --muted:#6b7280;
      --accent:#007aff; /* iOS blue */
      --danger:#ff3b30;
      --shadow: 0 8px 30px rgba(0,0,0,0.12);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Segoe UI Mono", monospace;
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#eef2f8 0%, #f7f7fa 100%);
      color:#111827;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:32px;
    }

    .window{
      width:min(1100px,96vw);
      height: min(720px,86vh);
      background:var(--card-bg);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(8px) saturate(120%);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,0.04);
    }

    .titlebar{
      display:flex;
      align-items:center;
      padding:12px 16px;
      gap:12px;
      border-bottom:1px solid rgba(0,0,0,0.04);
      background: linear-gradient(180deg, rgba(255,255,255,0.45), rgba(255,255,255,0.25));
    }

    .traffic{
      display:flex;gap:8px;align-items:center;width:64px;
    }
    .dot{width:12px;height:12px;border-radius:50%;}
    .dot.close{background:#ff5f56}
    .dot.min{background:#ffbd2e}
    .dot.max{background:#27c93f}

    .title{flex:1;font-weight:600;letter-spacing:0.2px}
    .subtitle{font-size:12px;color:var(--muted)}

    .toolbar{
      display:flex;gap:8px;align-items:center;padding:12px 16px;border-bottom:1px solid rgba(0,0,0,0.03);
      background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0));
    }

    .btn{
      background:transparent;border:1px solid rgba(0,0,0,0.06);padding:8px 12px;border-radius:10px;cursor:pointer;display:inline-flex;gap:8px;align-items:center;
      font-weight:600;color:#0f172a;transition:all .12s ease;outline:0;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .btn.primary{background:linear-gradient(180deg,var(--accent), #0060d6);color:white;border:0}
    .btn.ghost{background:transparent;border:0;color:var(--muted);font-weight:500}
    .btn.warn{background:linear-gradient(180deg,var(--danger), #d02b20);color:#fff;border:0}

    .spacer{flex:1}

    .controls{display:flex;gap:8px;align-items:center}
    .toggle{display:inline-flex;align-items:center;gap:8px;color:var(--muted);font-size:13px}
    .toggle input{width:44px;height:26px;position:relative;-webkit-appearance:none;background:#e6e7eb;border-radius:16px;padding:3px;outline:0;cursor:pointer}
    .toggle input:checked{background:linear-gradient(90deg,var(--accent),#0a84ff)}
    .toggle input::after{content:"";width:18px;height:18px;background:white;border-radius:50%;display:block;transition:transform .18s ease;box-shadow:0 2px 6px rgba(0,0,0,0.12)}
    .toggle input:checked::after{transform:translateX(18px)}

    .content{display:flex;flex:1;gap:16px;padding:16px}

    .panel{flex:1;display:flex;flex-direction:column;gap:12px}

    .console{
      background:linear-gradient(180deg,#0b1020 0%, #0f1724 100%);
      border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:12px;height:100%;color:#cbd5e1;box-shadow:inset 0 -8px 40px rgba(0,0,0,0.25);
      font-family:var(--mono);font-size:13px;line-height:1.45;overflow:hidden;border:1px solid rgba(255,255,255,0.03);
    }

    .console .output{flex:1;overflow:auto;padding-right:4px}
    .line{white-space:pre-wrap;padding:6px 8px;border-radius:6px}
    .line.info{color:#9ee6ff;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent)}
    .line.warn{color:#ffdba8}
    .line.err{color:#ffb3b3}
    .line.meta{color:#9aa4b2;font-size:12px}

    .input-row{display:flex;gap:8px;align-items:center}
    .text{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:inherit;font-family:inherit}

    footer{padding:12px 16px;border-top:1px solid rgba(0,0,0,0.03);display:flex;gap:12px;align-items:center}
    .muted{color:var(--muted);font-size:13px}

    @media (max-width:720px){
      .window{height:92vh;width:96vw}
      .toolbar{flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <div class="window" role="application" aria-label="WebSocket 控制台">
    <div class="titlebar">
      <div class="traffic" aria-hidden="true">
        <div class="dot close"></div>
        <div class="dot min"></div>
        <div class="dot max"></div>
      </div>
      <div class="title">WebSocket 控制台</div>
      <div class="subtitle">用于调试订阅与心跳 — 模板不包含真实后端调用</div>
    </div>

    <div class="toolbar">
      <div class="controls">
        <button id="connectBtn" class="btn primary">Connect</button>
        <button id="subscribeBtn" class="btn">Subscribe</button>
        <button id="pingBtn" class="btn">Ping</button>
        <button id="controlBtn" class="btn">Control Test</button>
        <button id="disconnectBtn" class="btn ghost">Disconnect</button>
        <button id="clearBtn" class="btn" title="清空日志">Clear</button>
      </div>

      <div class="spacer"></div>

      <label class="toggle" title="控制是否将新消息追加到日志末尾">
        <span>Append</span>
        <input type="checkbox" id="appendToggle" checked aria-label="是否追加日志" />
      </label>
    </div>

    <div class="content">
      <div class="panel">
        <div class="console" id="console">
          <div class="output" id="output" role="log" aria-live="polite"></div>

          <div class="input-row">
            <input id="payloadInput" class="text" placeholder='订阅示例: {"op":"subscribe","args":[{"channel":"tickers","instId":"BTC-USDT"}]}' aria-label="订阅负载" />
            <button id="sendBtn" class="btn">Send</button>
          </div>
        </div>
      </div>

      <div style="width:320px;max-width:38%;display:flex;flex-direction:column;gap:12px">
        <div style="background:linear-gradient(180deg,#fff,#f7f9fb);padding:12px;border-radius:12px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.03)">
          <div style="font-weight:700;margin-bottom:8px">Connection</div>
          <div id="connState" class="muted">Disconnected</div>
          <div style="height:8px"></div>
          <div style="font-weight:700;margin-bottom:8px">Actions</div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <div class="muted">此模板仅展示 UI 与交互, 无自动连接后端。</div>
            <div class="muted">可使用按钮模拟订阅或心跳。</div>
          </div>
        </div>

        <div style="background:linear-gradient(180deg,#fff,#f7f9fb);padding:12px;border-radius:12px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.03)">
          <div style="font-weight:700;margin-bottom:8px">Info</div>
          <div class="muted">快速键: Enter 发送负载; Esc 清空输入</div>
          <div style="height:8px"></div>
          <div style="font-size:13px;color:var(--muted)">模板版</div>
        </div>
      </div>
    </div>

    <footer>
      <div class="muted">状态: <span id="statusText">就绪</span></div>
      <div class="spacer"></div>
      <div class="muted">模板 · 仅前端展示</div>
    </footer>
  </div>

  <script>
    (function(){
      const connectBtn = document.getElementById('connectBtn');
      const disconnectBtn = document.getElementById('disconnectBtn');
      const subscribeBtn = document.getElementById('subscribeBtn');
      const pingBtn = document.getElementById('pingBtn');
      const controlBtn = document.getElementById('controlBtn');
      const clearBtn = document.getElementById('clearBtn');
      const sendBtn = document.getElementById('sendBtn');
      const payloadInput = document.getElementById('payloadInput');
      const output = document.getElementById('output');
      const connState = document.getElementById('connState');
      const statusText = document.getElementById('statusText');
      const appendToggle = document.getElementById('appendToggle');

      const WS_URL = 'ws://localhost:8533/as-api/ws/events';
      let socket = null;
      let connected = false;

      function isSocketOpen(){
        return socket && socket.readyState === WebSocket.OPEN;
      }

      function bindSocketEvents(ws){
        ws.addEventListener('open', ()=>{
          connected = true;
          connState.textContent = 'Connected';
          setStatus('已连接');
          addLine(`Connected to ${WS_URL}`, 'meta');
        });

        ws.addEventListener('message', (event)=>{
          addLine('< ' + event.data, 'info');
        });

        ws.addEventListener('error', (event)=>{
          addLine('Error: ' + (event.message || 'unknown'), 'err');
          setStatus('连接异常');
        });

        ws.addEventListener('close', (event)=>{
          connected = false;
          connState.textContent = 'Disconnected';
          setStatus('已断开');
          addLine(`Connection closed (${event.code})`, 'warn');
        });
      }

      function sendPayload(payload){
        if(!isSocketOpen()){
          addLine('请先连接 (Connect)', 'warn');
          return false;
        }
        try{
          socket.send(payload);
          addLine('> ' + payload, 'info');
          return true;
        }catch(err){
          addLine('发送失败: ' + err.message, 'err');
          return false;
        }
      }

      function addLine(text, level='info'){
        const append = appendToggle.checked;
        const node = document.createElement('div');
        node.className = 'line ' + (level||'info');
        node.textContent = text;
        if(!append){
          output.innerHTML = '';
        }
        output.appendChild(node);
        // keep scrolled to bottom
        output.scrollTop = output.scrollHeight;
      }

      function setStatus(s){
        statusText.textContent = s;
      }

      connectBtn.addEventListener('click', ()=>{
        if(isSocketOpen()){
          addLine('已经连接', 'warn');
          return;
        }
        if(socket && socket.readyState === WebSocket.CONNECTING){
          addLine('正在连接, 请稍候…', 'warn');
          return;
        }
        addLine(`Connecting to ${WS_URL}`, 'meta');
        setStatus('连接中…');
        connState.textContent = 'Connecting…';
        try{
          socket = new WebSocket(WS_URL);
          bindSocketEvents(socket);
        }catch(err){
          addLine('连接失败: ' + err.message, 'err');
          setStatus('连接失败');
          connState.textContent = 'Disconnected';
        }
      });

      disconnectBtn.addEventListener('click', ()=>{
        if(socket){
          socket.close(1000, 'client close');
          socket = null;
          addLine('Disconnect requested', 'meta');
        }else{
          addLine('当前无连接', 'warn');
        }
      });

      subscribeBtn.addEventListener('click', ()=>{
        const payload = payloadInput.value || '{"op":"subscribe","args":[{"channel":"tickers","instId":"BTC-USDT"}]}';
        if(sendPayload(payload)){
          setStatus('订阅请求已发送');
        }
      });

      pingBtn.addEventListener('click', ()=>{
        sendPayload('ping');
      });

      clearBtn.addEventListener('click', ()=>{
        output.innerHTML = '';
      });

      sendBtn.addEventListener('click', ()=>{
        const payload = payloadInput.value.trim();
        if(!payload){ addLine('请输入负载然后发送', 'warn'); return; }
        sendPayload(payload);
      });

      controlBtn.addEventListener('click', ()=>{
        const payload = JSON.stringify({ type: 'control', command: 'subscribe', params: { symbol: 'BTC-USD' } });
        if(sendPayload(payload)){
          setStatus('Control command sent');
        }
      });

      payloadInput.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          sendBtn.click();
        } else if(e.key === 'Escape'){
          payloadInput.value = '';
        }
      });

      // 初始化示例内容
      addLine('欢迎 · WebSocket 控制台模板', 'meta');
      addLine(`目标: ${WS_URL}`, 'meta');
      addLine('点击 Connect 后可使用 Subscribe / Ping / Send 模拟交互。', 'meta');
    })();
  </script>
</body>
</html>
